var e=Object.defineProperty,r=(r,o,n)=>((r,o,n)=>o in r?e(r,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[o]=n)(r,"symbol"!=typeof o?o+"":o,n);import{jsxDEV as o,Fragment as n}from"react/jsx-dev-runtime";import i from"react-dom/server";import{useState as t,useEffect as s,useRef as a,memo as l,useCallback as c,forwardRef as m,useImperativeHandle as d,useMemo as u}from"react";import{motion as h,useAnimation as g,AnimatePresence as p,useViewportScroll as v,useTransform as f}from"framer-motion";import{useQuery as N,QueryClient as b,QueryClientProvider as w}from"@tanstack/react-query";import x from"axios";import{gsap as C}from"gsap";import{IconFolder as y}from"@tabler/icons-react";import{useDebounce as F}from"use-debounce";import{useSpring as _,animated as I}from"react-spring";import{throttle as S}from"lodash-es";import L from"winston";import k from"yet-another-react-lightbox";import E from"yet-another-react-lightbox/plugins/captions";import T from"yet-another-react-lightbox/plugins/counter";import R from"yet-another-react-lightbox/plugins/zoom";import A from"yet-another-react-lightbox/plugins/thumbnails";import{openDB as P}from"idb";import{v4 as B}from"uuid";const M="_sidebar_1d71g_2",W="_logo_1d71g_7",V="_folderList_1d71g_12",H="_folderItem_1d71g_17",$="_folderButton_1d71g_22",z="_selectedFolder_1d71g_30",O="_uploadButton_1d71g_35",D={BASE_URL:"/",DEV:!0,MODE:"production",PROD:!1,SSR:!0,VITE_API_BASE_URL:"http://localhost:3000/",VITE_API_PORT:"3000",VITE_CACHE_TTL:"600000",VITE_CLIENT_PORT:"5173",VITE_MAX_UPLOAD_SIZE:"1610612736",VITE_USER_NODE_ENV:"development"}||{},U=(e,r)=>D[e]||r,q=parseInt(U("VITE_CACHE_TTL","600000"),10);parseInt(U("VITE_MAX_UPLOAD_SIZE","1610612736"),10),parseInt(U("VITE_CLIENT_PORT","5173"),10);const G=parseInt(U("VITE_API_PORT","3000"),10);U("VITE_API_BASE_URL",`http://localhost:${G}`),U("VITE_HOST","localhost");const Z="/api/folders",j=x.create({baseURL:"http://localhost:3000/"}),Q=async()=>{var e,r,o;try{console.log("Fetching folders from:",`${j.defaults.baseURL}/api/folders`);const e=await j.get(Z);if(console.log("Response headers:",e.headers),e.headers["content-type"].includes("application/json"))return e.data;throw console.error(`Unexpected content type: ${e.headers["content-type"]}`),console.error("Response data:",e.data),new Error(`Server returned unexpected content type: ${e.headers["content-type"]}`)}catch(n){if(x.isAxiosError(n))throw console.error("Axios error:",n.message),console.error("Response:",null==(e=n.response)?void 0:e.data),console.error("Request URL:",null==(r=n.config)?void 0:r.url),console.error("Request method:",null==(o=n.config)?void 0:o.method),new Error(`Failed to fetch folders: ${n.message}`);throw console.error("Error fetching folders:",n),new Error("Failed to fetch folders. Please try again later.")}};async function Y(e){if(!e)return console.warn("Folder parameter is missing or empty"),[];try{return(await j.get(`/api/images?folder=${encodeURIComponent(e)}`)).data.map((e=>({...e,width:isNaN(e.width)?0:e.width,height:isNaN(e.height)?0:e.height})))}catch(r){throw console.error("Error in getImages:",r),new Error("Failed to fetch images")}}function X(){return N({queryKey:["folders"],queryFn:Q,staleTime:3e5,retry:3})}const K=({selectedFolder:e,setSelectedFolder:r})=>{const{data:n,isLoading:i,error:t}=X();return i?o("div",{children:"Loading folders..."},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:20,columnNumber:25},void 0):t?o("div",{children:"Error loading folders"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:21,columnNumber:21},void 0):n?o(h.div,{initial:{x:-300},animate:{x:0},transition:{type:"spring",stiffness:120},className:M,children:o("div",{className:`${M} flex flex-col h-full`,children:[o("div",{className:W,children:"Lora Finder"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:34,columnNumber:9},void 0),o("ul",{className:`${V} flex-grow overflow-y-auto`,children:n.map((n=>o("li",{className:H,children:o("button",{onClick:()=>r(n.name),className:`${$} ${e===n.name?z:""}`,children:n.name},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:40,columnNumber:15},void 0)},n.name,!1,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:39,columnNumber:13},void 0)))},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:36,columnNumber:9},void 0),o("div",{className:"p-8 mt-auto",children:o("button",{className:`${O} w-full`,children:"Upload"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:53,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:52,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:32,columnNumber:7},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Sidebar.tsx",lineNumber:26,columnNumber:5},void 0):null},J=({currentDirectory:e})=>o(h.button,{className:"flex items-center bg-gray-700 px-3 py-1 rounded-md text-peach text-sm hover:bg-gray-600 transition-all duration-300 ease-in-out",whileHover:{scale:1.05},whileTap:{scale:.95},children:[o(y,{size:16,className:"mr-2 text-yellow-500"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/CurrentDirectoryButton.tsx",lineNumber:19,columnNumber:7},void 0),o(h.div,{className:"truncate max-w-xs",initial:{clipPath:"circle(0% at 50% 50%)"},animate:{clipPath:"circle(100% at 50% 50%)"},transition:{duration:.5},children:o("span",{children:e},void 0,!1,{fileName:"C:/loraFinder/src/client/components/CurrentDirectoryButton.tsx",lineNumber:28,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/CurrentDirectoryButton.tsx",lineNumber:22,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/CurrentDirectoryButton.tsx",lineNumber:13,columnNumber:5},void 0),ee="_searchBarContainer_3g2eh_1",re="_searchBackground_3g2eh_19",oe="_searchInput_3g2eh_41",ne="_suggestions_3g2eh_61",ie=({onSearch:e})=>{const[r,n]=t(""),[i]=F(r,300),[a,l]=t([]);g();return s((()=>{}),[i]),o(h.form,{onSubmit:o=>{o.preventDefault(),e(r)},className:ee,initial:{width:"200px"},animate:{width:r?"300px":"200px"},transition:{type:"spring",stiffness:300,damping:30},children:[o(h.div,{className:re,animate:{background:r?"linear-gradient(90deg, #4a00e0 0%, #8e2de2 100%)":"rgba(255, 255, 255, 0.1)"}},void 0,!1,{fileName:"C:/loraFinder/src/client/components/SearchBar.tsx",lineNumber:41,columnNumber:7},void 0),o(h.input,{type:"text",value:r,onChange:e=>n(e.target.value),className:oe,placeholder:"Search the future...",whileFocus:{scale:1.05},transition:{type:"spring",stiffness:400,damping:30}},void 0,!1,{fileName:"C:/loraFinder/src/client/components/SearchBar.tsx",lineNumber:49,columnNumber:7},void 0),a.length>0&&o(h.ul,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:ne,children:a.map(((e,r)=>o(h.li,{whileHover:{scale:1.02,backgroundColor:"rgba(255,255,255,0.1)"},children:e},r,!1,{fileName:"C:/loraFinder/src/client/components/SearchBar.tsx",lineNumber:65,columnNumber:13},void 0)))},void 0,!1,{fileName:"C:/loraFinder/src/client/components/SearchBar.tsx",lineNumber:59,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/SearchBar.tsx",lineNumber:34,columnNumber:5},void 0)},te=({zoom:e,onZoomChange:r})=>{const n=_({width:(e-.5)/1.5*100+"%",config:{tension:300,friction:10}});return o("div",{className:"flex items-center bg-gray-600 rounded-full p-2 overflow-hidden",children:[o(h.svg,{whileHover:{scale:1.2},className:"text-gray-200 mr-2",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:o("path",{d:"M21 21L16.65 16.65M11 8V14M8 11H14M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ZoomSlider.tsx",lineNumber:31,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ZoomSlider.tsx",lineNumber:22,columnNumber:7},void 0),o("div",{className:"relative w-24 h-2 bg-gray-500 rounded-full overflow-hidden",children:[o(I.div,{className:"absolute top-0 left-0 h-full bg-blue-400 rounded-full",style:n},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ZoomSlider.tsx",lineNumber:35,columnNumber:9},void 0),o("input",{type:"range",min:"0.5",max:"2",step:"0.1",value:e,onChange:e=>r(parseFloat(e.target.value)),className:"absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ZoomSlider.tsx",lineNumber:36,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/ZoomSlider.tsx",lineNumber:34,columnNumber:7},void 0),o(h.svg,{whileHover:{scale:1.2},className:"text-gray-200 ml-2",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:o("path",{d:"M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ZoomSlider.tsx",lineNumber:56,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ZoomSlider.tsx",lineNumber:47,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/ZoomSlider.tsx",lineNumber:20,columnNumber:5},void 0)},se={navbar:"_navbar_xufv4_2",leftSection:"_leftSection_xufv4_9",rightSection:"_rightSection_xufv4_14",navbarBackground:"_navbarBackground_xufv4_18",viewToggleButton:"_viewToggleButton_xufv4_60",morph:"_morph_xufv4_1"},ae=({currentDirectory:e,onSearch:r,zoom:n,onZoomChange:i,isGrouped:t,onGroupToggle:l})=>{const c=a(null),m=g(),d=a(null);return s((()=>{const e=c.current;if(e){const r=e.querySelector("path");r&&C.to(r,{attr:{d:"M0,0 Q100,50 200,0 T400,0 V100 Q300,150 200,100 T0,100 Z"},duration:2,repeat:-1,yoyo:!0,ease:"power1.inOut"})}}),[]),s((()=>{d.current&&C.to(d.current,{opacity:.7,duration:2,repeat:-1,yoyo:!0,ease:"power1.inOut"})}),[]),o(h.nav,{className:se.navbar,initial:{y:-50,opacity:0},animate:{y:0,opacity:1},transition:{duration:.5,ease:"easeOut"},children:[o("div",{ref:d,className:se.cornerLight},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:82,columnNumber:7},void 0),o("svg",{ref:c,className:se.navbarBackground,children:o("path",{d:"M0,0 Q50,20 100,10 T200,30 T300,5 T400,25 V100 Q350,80 300,90 T200,70 T100,95 T0,75 Z"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:84,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:83,columnNumber:7},void 0),o(h.div,{className:se.leftSection,whileHover:{scale:1.05},whileTap:{scale:.95},animate:m,children:[o(J,{currentDirectory:e},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:93,columnNumber:9},void 0),o(ie,{onSearch:r},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:95,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:86,columnNumber:7},void 0),o(h.div,{className:se.rightSection,whileHover:{scale:1.05},whileTap:{scale:.95},children:[o(h.button,{onClick:l,className:se.viewToggleButton,whileHover:{scale:1.05},whileTap:{scale:.95},children:t?"Ungroup":"Group"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:103,columnNumber:9},void 0),o(te,{zoom:n,onZoomChange:i},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:112,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:97,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/Navbar.tsx",lineNumber:76,columnNumber:5},void 0)},le="_particleBackground_qcgvf_1";let ce;ce="undefined"!=typeof window?{error:console.error,warn:console.warn,info:console.info,debug:console.debug,log:console.log}:L.createLogger({level:"info",format:L.format.combine(L.format.timestamp(),L.format.json()),transports:[new L.transports.Console,new L.transports.File({filename:"error.log",level:"error"}),new L.transports.File({filename:"combined.log"})]});const me=ce,de=()=>{const e=a(null),r=5e3;return s((()=>{(()=>{if(!e.current)return;const o=e.current.getContext("webgl2");if(!o)return void me.error("WebGL 2 not supported");const n=ue(o,o.VERTEX_SHADER,"\n        attribute vec3 position;\n        attribute vec4 color;\n        varying vec4 vColor;\n        uniform float time;\n        void main() {\n          float angle = time * 0.1 + float(gl_InstanceID);\n          float shimmer = (sin(angle) * 0.5 + 0.5) * 0.3;\n          gl_Position = vec4(position, 1.0);\n          vColor = color * (1.0 + shimmer);\n        }\n      "),i=ue(o,o.FRAGMENT_SHADER,"\n        precision mediump float;\n        varying vec4 vColor;\n        void main() {\n          float star = smoothstep(0.5, 0.0, length(vColor.rgb));\n          gl_FragColor = vec4(vColor.rgb * star, star);\n        }\n      ");if(!n||!i)return void me.error("Failed to create shaders");const t=he(o,n,i);if(!t)return void me.error("Failed to create shader program");const s=o.getAttribLocation(t,"position"),a=o.getAttribLocation(t,"color"),l=o.getUniformLocation(t,"time");if(-1===s||-1===a||null===l)return void me.error("Failed to get attribute or uniform locations");const c=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,c);const m=new Float32Array(35e3);for(let e=0;e<r;e++){const r=7*e;m[r]=2*Math.random()-1,m[r+1]=2*Math.random()-1,m[r+2]=Math.random(),m[r+3]=Math.random(),m[r+4]=Math.random(),m[r+5]=Math.random(),m[r+6]=.5*Math.random()+.5}o.bufferData(o.ARRAY_BUFFER,m,o.STATIC_DRAW);const d=S((n=>{var i;const t=null==(i=e.current)?void 0:i.getBoundingClientRect();if(!t)return;const s=(n.clientX-t.left)/t.width*2-1,a=-(n.clientY-t.top)/t.height*2+1;o.bindBuffer(o.ARRAY_BUFFER,c);const l=new Float32Array(35e3);o.bufferSubData(o.ARRAY_BUFFER,0,l);for(let e=0;e<r;e++){const r=7*e;l[r]+=.01*(s-l[r]),l[r+1]+=.01*(a-l[r+1])}o.bufferSubData(o.ARRAY_BUFFER,0,l)}),16);window.addEventListener("mousemove",d);const u=performance.now(),h=()=>{const e=(performance.now()-u)/1e3;o.viewport(0,0,o.canvas.width,o.canvas.height),o.clearColor(0,0,0,1),o.clear(o.COLOR_BUFFER_BIT),o.useProgram(t),o.uniform1f(l,e),o.bindBuffer(o.ARRAY_BUFFER,c),o.enableVertexAttribArray(s),o.vertexAttribPointer(s,3,o.FLOAT,!1,28,0),o.enableVertexAttribArray(a),o.vertexAttribPointer(a,4,o.FLOAT,!1,28,12),o.drawArrays(o.POINTS,0,r),requestAnimationFrame(h)};h()})()}),[]),o("canvas",{ref:e,className:le},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ParticleBackground.tsx",lineNumber:141,columnNumber:10},void 0)},ue=(e,r,o)=>{const n=e.createShader(r);return n?(e.shaderSource(n,o),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)?n:(me.error("An error occurred compiling the shaders: "+e.getShaderInfoLog(n)),e.deleteShader(n),null)):(me.error("Unable to create shader"),null)},he=(e,r,o)=>{if(!r||!o)return me.error("Invalid shaders"),null;const n=e.createProgram();return n?(e.attachShader(n,r),e.attachShader(n,o),e.linkProgram(n),e.getProgramParameter(n,e.LINK_STATUS)?n:(me.error("Unable to initialize the shader program: "+e.getProgramInfoLog(n)),null)):(me.error("Unable to create program"),null)},ge="_lottieBackground_e0o2j_1",pe="_animatedBackground_e0o2j_12",ve=()=>{const e=a(null);return s((()=>{const r=r=>{if(e.current){const o=r.clientX/window.innerWidth,n=r.clientY/window.innerHeight;e.current.style.background=`\n          radial-gradient(\n            circle at ${100*o}% ${100*n}%,\n            rgba(238, 119, 82, 0.3),\n            rgba(231, 60, 126, 0.3),\n            rgba(35, 166, 213, 0.3),\n            rgba(35, 213, 171, 0.3)\n          )\n        `}};return window.addEventListener("mousemove",r),()=>window.removeEventListener("mousemove",r)}),[]),o("div",{className:ge,children:o("div",{ref:e,className:pe},void 0,!1,{fileName:"C:/loraFinder/src/client/components/LottieBackground.tsx",lineNumber:31,columnNumber:7},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/LottieBackground.tsx",lineNumber:30,columnNumber:5},void 0)},fe=({folders:e,selectedFolder:r,onFolderChange:n,currentDirectory:i,onSearch:t,zoom:s,onZoomChange:a,isGrouped:l,onGroupToggle:c,children:m})=>o("div",{className:"flex flex-col h-screen relative bg-transparent",children:[o("div",{className:"gradient-overlay"},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Layout.tsx",lineNumber:39,columnNumber:7},void 0),o(ve,{},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Layout.tsx",lineNumber:40,columnNumber:7},void 0),o(de,{},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Layout.tsx",lineNumber:41,columnNumber:7},void 0),o(ae,{currentDirectory:i,onSearch:t,zoom:s,onZoomChange:a,isGrouped:l,onGroupToggle:c},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Layout.tsx",lineNumber:42,columnNumber:7},void 0),o("div",{className:"flex flex-1 overflow-hidden",children:[o(K,{selectedFolder:r,setSelectedFolder:n},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Layout.tsx",lineNumber:51,columnNumber:9},void 0),o("main",{className:"flex-1 overflow-auto p-4 relative bg-transparent",children:o("div",{className:"relative z-10",children:m},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Layout.tsx",lineNumber:56,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/Layout.tsx",lineNumber:55,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/Layout.tsx",lineNumber:50,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/Layout.tsx",lineNumber:38,columnNumber:5},void 0),Ne="_imageItem_vfy41_3",be="_groupCounter_vfy41_40",we="_imageSkeleton_vfy41_126",xe="_skeletonAnimation_vfy41_133",Ce=({containerWidth:e,containerHeight:r})=>o("div",{className:`${Ne} ${we}`,style:{width:e,height:r,maxWidth:"100%",maxHeight:"100%",aspectRatio:`${e} / ${r}`},children:o("div",{className:xe},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageSkeleton.tsx",lineNumber:21,columnNumber:7},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageSkeleton.tsx",lineNumber:11,columnNumber:5},void 0),ye="_imageWrapper_72h1w_25",Fe="_visible_72h1w_62",_e="_parallaxLayer_72h1w_89";const Ie=l((({image:e,onClick:r,containerWidth:n,containerHeight:i,zoom:l,groupCount:m,workerPool:d,imageProcessor:u})=>{const[g,v]=function(e={}){const[r,o]=t(!1),n=a(null);return s((()=>{const r=new IntersectionObserver((([e])=>{o(e.isIntersecting)}),e);return n.current&&r.observe(n.current),()=>{n.current&&r.unobserve(n.current)}}),[e]),[n,r]}({threshold:.1,triggerOnce:!0}),[f,N]=t(null),b=c((r=>{console.log("Image processed:",e.id),N(r)}),[e.id]);s((()=>{v&&d.processImage(e,v).then(b)}),[v,e,d,b]);return o(h.div,{ref:g,className:Ne,style:{width:n,height:i},whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>r(e),initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{type:"spring",stiffness:260,damping:20},children:[o(p,{children:v?o(h.div,{initial:"hidden",animate:"visible",exit:"hidden",variants:{hidden:{clipPath:"inset(100% 0 0 0)"},visible:{clipPath:"inset(0% 0 0 0)",transition:{duration:.5,ease:"easeOut"}}},children:o(h.img,{src:f||e.src,alt:e.alt,style:{width:"100%",height:"100%",objectFit:"cover"},whileHover:{scale:1.1,transition:{duration:.3}}},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageItem.tsx",lineNumber:87,columnNumber:13},void 0)},"image",!1,{fileName:"C:/loraFinder/src/client/components/ImageItem.tsx",lineNumber:80,columnNumber:11},void 0):o(h.div,{className:we,style:{width:"100%",height:"100%",backgroundColor:"#f0f0f0"}},"skeleton",!1,{fileName:"C:/loraFinder/src/client/components/ImageItem.tsx",lineNumber:102,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageItem.tsx",lineNumber:78,columnNumber:7},void 0),m&&m>1&&o(h.div,{className:be,initial:{opacity:0,scale:.5},animate:{opacity:1,scale:1},transition:{delay:.2,duration:.3},children:m},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageItem.tsx",lineNumber:115,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/ImageItem.tsx",lineNumber:57,columnNumber:5},void 0)}),((e,r)=>e.image.id===r.image.id&&e.containerWidth===r.containerWidth&&e.containerHeight===r.containerHeight&&e.zoom===r.zoom&&e.groupCount===r.groupCount)),Se="_imageRow_1vrqf_1",Le="_imageWrapper_1vrqf_19",ke=m(((e,r)=>{var n;const{images:i,onImageClick:l,columns:c,zoom:m,isLastRow:u,groupedImages:g,rowHeight:p,processedImages:v,workerPool:f,imageProcessor:N,isVisible:b,isIntersecting:w,intersectionRef:x,layout:C,containerWidth:y}=e,F=a(null);d(r,(()=>({getNode:()=>F.current})));const[_,I]=t(0),{width:S}=function(){const[e,r]=t({width:void 0,height:void 0});return s((()=>{let e=null,o=window.innerWidth,n=window.innerHeight;function i(){e&&clearTimeout(e),e=setTimeout((()=>{const e=window.innerWidth,i=window.innerHeight;e===o&&i===n||(o=e,n=i,r({width:e,height:i}))}),200)}return window.addEventListener("resize",i),i(),()=>window.removeEventListener("resize",i)}),[]),e}();if(s((()=>{F.current&&I(F.current.offsetWidth)}),[F.current,S]),!i||0===i.length)return null;const L=i.reduce(((e,r)=>e+r.width/r.height),0),k=_*m,E=i.map(((e,r)=>e.width/e.height/L*k)),T=(u&&i.length,E[0]/i[0].width*i[0].height),R={hidden:{opacity:0,scale:.8},visible:{opacity:1,scale:1,transition:{type:"spring",damping:15,stiffness:100}}};if(!b)return o("div",{style:{height:T}},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageRow.tsx",lineNumber:129,columnNumber:12},void 0);if(!b||!w)return o("div",{ref:x,style:{height:T}},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageRow.tsx",lineNumber:133,columnNumber:12},void 0);const A=isNaN(T)||T<=0?`${p}px`:`${T}px`;return o(h.div,{ref:F,className:Se,variants:{hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},initial:"hidden",animate:"visible",style:{height:A,transform:`translateY(${(null==(n=C[0])?void 0:n.y)??0}px)`},children:i.map(((e,r)=>{const n=g.find((r=>r.images.some((r=>r.id===e.id)))),i=n?n.images.length:1;return o(h.div,{className:Le,style:{width:E[r]/k*100+"%",height:T},variants:R,"data-image-id":e.id,children:o(Ie,{image:e,onClick:()=>l(e,n?n.images:[e]),containerWidth:E[r],containerHeight:T,zoom:m,groupCount:i,imageProcessor:N,workerPool:f},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageRow.tsx",lineNumber:167,columnNumber:13},void 0)},e.id,!1,{fileName:"C:/loraFinder/src/client/components/ImageRow.tsx",lineNumber:157,columnNumber:11},void 0)}))},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageRow.tsx",lineNumber:141,columnNumber:5},void 0)}));function Ee(e){if(!e)return"Untitled";const r=e.replace(/\.[^/.]+$/,"").replace(/\.(preview|thumbnail)$/,"").replace(/_thumb$/,"").replace(/\s*\d+$/,"").replace(/[_-]/g," ").replace(/\w\S*/g,(e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())).trim();return r.length>30?r.substring(0,30)+"...":r}function Te(e){return new Worker("/assets/imageProcessorWorker-DVqXY4Ow.js",{name:null==e?void 0:e.name})}class Re{constructor(e){r(this,"workers"),r(this,"queue"),r(this,"busyWorkers"),this.workers=Array.from({length:e},(()=>new Te)),this.queue=[],this.busyWorkers=new Set,this.workers.forEach((e=>{e.onmessage=this.handleWorkerMessage.bind(this,e)}))}handleWorkerMessage(e,r){if("imageProcessed"===r.data.action){const o=this.queue.shift();o&&o.resolve(r.data.processedImage),this.busyWorkers.delete(e),this.processQueue()}}processQueue(){for(this.queue.sort(((e,r)=>e.isVisible===r.isVisible?0:e.isVisible?-1:1));this.queue.length>0&&this.busyWorkers.size<this.workers.length;){const e=this.workers.find((e=>!this.busyWorkers.has(e)));if(e){const r=this.queue.shift();e.postMessage({action:"processImage",...r.image,isVisible:r.isVisible}),this.busyWorkers.add(e)}}}processImage(e,r){return new Promise((o=>{this.queue.push({image:e,resolve:o,isVisible:r}),this.processQueue()}))}terminate(){this.workers.forEach((e=>e.terminate()))}}class Ae{constructor(e){console.warn("NodeWorkerPool is not implemented yet")}processImage(e,r){return console.warn("NodeWorkerPool.processImage is not implemented yet"),Promise.resolve("dummy-processed-image-data")}terminate(){console.warn("NodeWorkerPool.terminate is not implemented yet")}}const Pe={};function Be(e){const r=Pe[e];if(r&&Date.now()<r.expiry)return r.data}function Me(e,r){Pe[e]={data:r,expiry:Date.now()+q},function(){const e=Object.keys(Pe);if(e.length>100){const r=e.reduce(((e,r)=>Pe[e].expiry<Pe[r].expiry?e:r));delete Pe[r]}}()}function We(e,r){const o=Be(e);return!!o&&o.some((e=>e.id===r))}class Ve{constructor(){r(this,"worker"),r(this,"db",null),r(this,"messageQueue",[]),r(this,"isProcessing",!1),r(this,"onMessage",null),this.worker=new Worker(new URL("./imageProcessorWorker.ts",import.meta.url),{type:"module"}),this.initDB(),this.worker.onmessage=this.handleWorkerMessage.bind(this)}async initDB(){this.db=await P("imageCache",1,{upgrade(e){e.createObjectStore("images")}})}async getCachedImage(e){return this.db?this.db.get("images",e):null}async cacheImage(e,r){this.db&&await this.db.put("images",r,e)}async processNextMessage(){if(this.isProcessing||0===this.messageQueue.length)return;this.isProcessing=!0;const e=this.messageQueue.shift();"processImage"===e.action&&"images"in e?await this.processImage(e.images[0]):"processBatch"===e.action&&"images"in e&&await this.processBatch(e.images),this.isProcessing=!1,this.processNextMessage()}async processImage(e){const r=await this.getCachedImage(e.id);r?this.postMessage({action:"imageProcessed",id:e.id,processedImage:r,folder:e.folder}):this.worker.postMessage({action:"processImage",...e})}async processBatch(e){const r=[],o=[];for(const n of e)if(We(n.folder,n.id)){const e=await this.getCachedImage(n.id);e?o.push({action:"imageProcessed",id:n.id,processedImage:e,folder:n.folder}):r.push(n)}else r.push(n);o.forEach((e=>this.postMessage(e))),r.length>0&&this.worker.postMessage({action:"processBatch",images:r})}handleWorkerMessage(e){if("imageProcessed"===e.data.action){this.cacheImage(e.data.id,e.data.processedImage),this.postMessage(e.data);const r=(Be(e.data.folder)||[]).map((r=>r.id===e.data.id?{...r,processedImage:e.data.processedImage}:r));Me(e.data.folder,r)}else"batchProcessed"===e.data.action&&e.data.results.forEach((e=>{this.cacheImage(e.id,e.processedImage),this.postMessage({action:"imageProcessed",id:e.id,processedImage:e.processedImage,folder:e.folder});const r=(Be(e.folder)||[]).map((r=>r.id===e.id?{...r,processedImage:e.processedImage}:r));Me(e.folder,r)}))}postMessage(e){"processBatch"===e.action||"processImage"===e.action?(this.messageQueue.push(e),this.processNextMessage()):this.onMessage&&this.onMessage(e)}terminate(){this.worker.terminate()}}function He(e){return new Worker("/assets/layoutWorker-CLx-TE34.js",{name:null==e?void 0:e.name})}const $e=({children:e,chunkIndex:r,setVisibleChunks:n})=>{const i=a(null);return s((()=>{const e=new IntersectionObserver((([e])=>{e.isIntersecting&&n((e=>[...e,r]))}),{threshold:.1});return i.current&&e.observe(i.current),()=>e.disconnect()}),[r,n]),o("div",{ref:i,children:e},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ChunkObserver.tsx",lineNumber:29,columnNumber:10},void 0)},ze=({images:e,isLoading:r,isGrouped:n,zoom:i})=>{const[l,m]=t(e.slice(0,20)),[d,g]=t(!0),[p,N]=t(-1),[b,w]=t(4),[x,C]=t([]),[y,F]=t([]),_=a(null),{scrollY:I}=v(),S=f(I,[0,300],[0,200]),L=f(I,[0,300],[0,-200]),[P,M]=t({}),[W,V]=t([]),[H,$]=t(new Set),z=a(null),[O,D]=t(0);console.log("ImageFeed rendering with images:",e.length);const U=u((()=>{if(!n)return e.map((e=>({key:e.id,images:[e],isCarousel:!1})));const r={};return e.forEach((e=>{const o=Ee(e.alt);r[o]||(r[o]=[]),r[o].push(e)})),console.log("groupedImages updated:",r.length),Object.entries(r).map((([e,r])=>({key:e,images:r,isCarousel:r.length>1})))}),[e,n]),q=u((()=>{const e=[];let r=[],o=0;U.forEach((n=>{const i=n.images[0],t=i.width/i.height;o+t>b&&r.length>0&&(e.push(r),r=[],o=0),r.push(i),o+=t})),r.length>0&&e.push(r);const n=[];for(let i=0;i<e.length;i+=20)n.push(e.slice(i,i+20));return 0===n.length&&e.length>0&&n.push(e),console.log("groupedRows updated:",n.length),n}),[e,U,b,20]),G=c((e=>{const r=U.findIndex((r=>r.images.some((r=>r.id===e.id))));if(-1!==r){const e=U[r];N(r),C(e.images)}}),[U,e]);c((()=>{const r=e.slice(l.length,l.length+20);m((e=>[...e,...r])),l.length+r.length>=e.length&&g(!1)}),[e,l]),c((e=>`/api/images/${e.replace(/^(\/|api\/image\/)+/,"").replace(/\\/g,"/")}`),[]);s((()=>{const e=()=>{const e=window.innerWidth,r=(o=e)>=2560?7:o>=1920?6:o>=1440?5:o>=1200?4:o>=992?3:o>=576?2:1;var o;w(r)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)}),[]),s((()=>{const e=()=>{const e=_.current;if(!e)return;const r=e.scrollTop,o=e.clientHeight,n=e.scrollHeight,i=q.map(((i,t)=>{const s=e.querySelector(`.image-row:nth-child(${t+1})`);if(!s)return 0;const a=s.offsetTop,l=s.clientHeight;return(r-a)/(n-o)*(o-l)}));F(i)},r=_.current;return r&&r.addEventListener("scroll",e),()=>{r&&r.removeEventListener("scroll",e)}}),[q]),s((()=>{const e=()=>{var e;const r=window.scrollY,o=null==(e=_.current)?void 0:e.querySelectorAll(".image-row");null==o||o.forEach(((e,o)=>{const n=r*(1+o%3*.1),i=5*Math.sin(.002*r+o);e.animate([{transform:`translateY(${n}px) rotateX(${i}deg) translateZ(${10*-o}px)`}],{duration:1e3,fill:"forwards",easing:"ease-out"})}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)}),[]),s((()=>{const e=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting?e.target.classList.add(Fe):e.target.classList.remove(Fe)}))}),{root:null,rootMargin:"0px",threshold:.1});return document.querySelectorAll(`.${ye}`).forEach((r=>{e.observe(r)})),()=>e.disconnect()}),[]),s((()=>{console.log("Starting image processing"),U.forEach((e=>{e.images.forEach((e=>{K.processImage(e,H.has(e.id)).then((r=>{console.log("Image processed:",e.id),M((o=>({...o,[e.id]:{...o[e.id],low:r}})))}))}))}))}),[U]);const Z=u((()=>new Ve),[]);s((()=>(z.current||(z.current=new He),()=>{z.current&&z.current.terminate()})),[]);const j=a(null),[Q,Y]=t(!1);s((()=>{const e=new IntersectionObserver((([e])=>{Y(e.isIntersecting)}),{threshold:.1});return j.current&&e.observe(j.current),()=>{j.current&&e.unobserve(j.current)}}),[]);const X=c((()=>{if(Q&&j.current){const e=j.current.getAttribute("data-image-id");e&&$((r=>new Set(r).add(e)))}}),[Q,j]);s((()=>{X()}),[X]),s((()=>{if(z.current&&H.size>0&&_.current){const r=e.filter((e=>H.has(e.id)));z.current.postMessage({action:"calculateLayout",images:r,containerWidth:_.current.clientWidth,containerHeight:_.current.clientHeight,targetRowHeight:200}),z.current.onmessage=e=>{"layoutCalculated"===e.data.action&&F(e.data.layout)}}}),[H,e]),s((()=>{_.current&&D(_.current.clientWidth)}),[]);const K=u((()=>function(e=4){return"undefined"!=typeof window&&"undefined"!=typeof Worker?new Re(e):new Ae(e)}(navigator.hardwareConcurrency||4)),[]);return s((()=>()=>{K.terminate()}),[K]),o("div",{className:"image-feed overflow-x-hidden",ref:_,style:{perspective:"1000px"},children:[o(h.div,{className:_e,style:{y:S}},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageFeed.tsx",lineNumber:399,columnNumber:7},void 0),q.map(((e,r)=>o($e,{chunkIndex:r,setVisibleChunks:V,children:e.map(((e,n)=>o(ke,{images:e,onImageClick:G,columns:b,zoom:i,isLastRow:n===q.length-1,groupedImages:U,rowHeight:200,processedImages:P,workerPool:K,imageProcessor:Z,isVisible:W.includes(Math.floor(n/20)),isIntersecting:Q,intersectionRef:j,layout:[{id:B(),x:0,y:y[20*r+n]||0,width:O,height:200}],containerWidth:O},`${r}-${n}`,!1,{fileName:"C:/loraFinder/src/client/components/ImageFeed.tsx",lineNumber:409,columnNumber:13},void 0)))},r,!1,{fileName:"C:/loraFinder/src/client/components/ImageFeed.tsx",lineNumber:403,columnNumber:9},void 0))),r&&o(Ce,{containerWidth:800,containerHeight:600},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageFeed.tsx",lineNumber:441,columnNumber:9},void 0),o(k,{slides:x.map((e=>({src:e.src,alt:e.alt,title:Ee(e.alt),description:`Image ${e.id}`}))),open:p>=0,index:p,close:()=>N(-1),plugins:[E,T,R,...x.length>1?[A]:[]],thumbnails:{position:"bottom",width:120,height:80,border:1,borderRadius:4,padding:4,gap:16},animation:{fade:300,swipe:300},carousel:{finite:!0,preload:2}},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageFeed.tsx",lineNumber:443,columnNumber:7},void 0),o(h.div,{className:_e,style:{y:L}},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageFeed.tsx",lineNumber:477,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/ImageFeed.tsx",lineNumber:394,columnNumber:5},void 0)},Oe="_imageViewer_feuzf_1",De="_contentContainer_feuzf_8",Ue=({images:e,isLoading:r,error:n,selectedFolder:i,isGrouped:t,zoom:s})=>o("div",{className:`${Oe} flex flex-col h-full`,children:o("div",{className:`${De} flex-1`,children:n?o("div",{className:"text-center text-accent-red",children:[o("p",{children:["Error: ",n instanceof Error?n.message:String(n)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/ImageViewer.tsx",lineNumber:35,columnNumber:13},void 0),o("p",{children:"Please try again later or contact support if the problem persists."},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageViewer.tsx",lineNumber:36,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/ImageViewer.tsx",lineNumber:34,columnNumber:11},void 0):r?o("div",{className:"text-center text-gray-300",children:"Loading images..."},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageViewer.tsx",lineNumber:42,columnNumber:11},void 0):0===e.length?o("div",{className:"text-center text-gray-300",children:"No images found in this folder."},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageViewer.tsx",lineNumber:45,columnNumber:11},void 0):o(ze,{images:e,isLoading:r,isGrouped:t,zoom:s},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageViewer.tsx",lineNumber:50,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageViewer.tsx",lineNumber:30,columnNumber:7},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/ImageViewer.tsx",lineNumber:28,columnNumber:5},void 0),qe=({selectedFolder:e,searchQuery:r,zoom:i,isGrouped:t})=>{const{data:s,isLoading:a,error:l}=N({queryKey:["images",c=e],queryFn:()=>Y(c),enabled:!!c,staleTime:12e4,retry:2});var c;if(console.log("MainContent rendering",{images:s,selectedFolder:e,searchQuery:r,isLoading:a,error:l,zoom:i,isGrouped:t}),a)return o("div",{children:"Loading images..."},void 0,!1,{fileName:"C:/loraFinder/src/client/components/MainContent.tsx",lineNumber:29,columnNumber:12},void 0);if(l)return o("div",{children:["Error loading images: ",l.message]},void 0,!0,{fileName:"C:/loraFinder/src/client/components/MainContent.tsx",lineNumber:33,columnNumber:12},void 0);const m=u((()=>s?r?s.filter((e=>e.alt.toLowerCase().includes(r.toLowerCase()))):s:[]),[s,r]);return o(n,{children:o(Ue,{images:m,isLoading:a,error:l,selectedFolder:e,zoom:i,isGrouped:t},void 0,!1,{fileName:"C:/loraFinder/src/client/components/MainContent.tsx",lineNumber:49,columnNumber:7},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/components/MainContent.tsx",lineNumber:47,columnNumber:5},void 0)},Ge=({webGLSupported:e})=>{const[r,n]=t(""),[i,a]=t([]),[l,c]=t(1),[m,d]=t(""),[u,h]=t(""),[g,p]=t(!0),{data:v,isLoading:f,error:N}=X();s((()=>{(async()=>{if(!r)return void a([]);const e=await Y(r);a(e)})()}),[r]);return o(fe,{folders:v??[],selectedFolder:r,onFolderChange:e=>{n(e)},currentDirectory:u,onSearch:e=>{d(e)},zoom:l,onZoomChange:e=>{c(e)},isGrouped:g,onGroupToggle:()=>{p((e=>!e))},children:o(qe,{images:i,selectedFolder:r,searchQuery:m,isLoading:f,error:(null==N?void 0:N.message)??null,zoom:l,isGrouped:g},void 0,!1,{fileName:"C:/loraFinder/src/client/pages/Home.tsx",lineNumber:104,columnNumber:7},void 0)},void 0,!1,{fileName:"C:/loraFinder/src/client/pages/Home.tsx",lineNumber:93,columnNumber:5},void 0)},Ze=new b;function je({webGLSupported:e=!1}){return o(w,{client:Ze,children:o("div",{className:"App",children:o(Ge,{webGLSupported:e},void 0,!1,{fileName:"C:/loraFinder/src/client/App.tsx",lineNumber:15,columnNumber:9},this)},void 0,!1,{fileName:"C:/loraFinder/src/client/App.tsx",lineNumber:14,columnNumber:7},this)},void 0,!1,{fileName:"C:/loraFinder/src/client/App.tsx",lineNumber:13,columnNumber:5},this)}async function Qe(e){return{html:i.renderToString(o(je,{},void 0,!1,{fileName:"C:/loraFinder/src/entry-server.tsx",lineNumber:13,columnNumber:49},this))}}export{Qe as render};
//# sourceMappingURL=entry-server.js.map
